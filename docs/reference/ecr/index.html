<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>ECR - Layer0</title>
      
      
      
        <link rel="canonical" href="https://github.com/quintilesims/layer0/reference/ecr/">
      
      
        <meta name="author" content="xfra">
      
    
    <meta property="og:url" content="https://github.com/quintilesims/layer0/reference/ecr/">
    <meta property="og:title" content="Layer0">
    <meta property="og:image" content="https://github.com/quintilesims/layer0/reference/ecr//../../static/logo_icon.png">
    <meta name="apple-mobile-web-app-title" content="Layer0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
      <link rel="apple-touch-icon" href="../../static/logo_icon.png">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-b64b728552.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/palettes-05ab2406df.css">
    
    
      
      
      
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto+Mono">
      <style>
        body, input {
          font-family: 'Roboto', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class="palette-primary-red palette-accent-grey">
    
      
      
        
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Reference <i class="icon icon-link"></i>
              
            
          </span>
        
        ECR
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/quintilesims/layer0/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="../../static/logo_icon.png">
        </div>
      
      <div class="name">
        <strong>Layer0 v0.9.0</strong>
        
          <br>
          quintilesims/layer0
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="../../#download" title="Download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/quintilesims/layer0//stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Home" href="../..">
      Home
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Releases" href="../../releases/">
      Releases
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Introduction" href="../../intro/">
      Introduction
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Setup</span>
    <ul>
      
        
  <li>
    <a class="" title="Install" href="../../setup/install/">
      Install
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Upgrade" href="../../setup/upgrade/">
      Upgrade
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Destroy" href="../../setup/destroy/">
      Destroy
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Guides</span>
    <ul>
      
        
  <li>
    <a class="" title="Guestbook" href="../../guides/guestbook/">
      Guestbook
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Guestbook with a DB" href="../../guides/guestbook_db/">
      Guestbook with a DB
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Consul" href="../../guides/consul/">
      Consul
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Guestbook with Consul" href="../../guides/guestbook_consul/">
      Guestbook with Consul
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="One-off Task" href="../../guides/one_off_task/">
      One-off Task
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Reference</span>
    <ul>
      
        
  <li>
    <a class="" title="Layer0 CLI" href="../cli/">
      Layer0 CLI
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Layer0 Setup CLI" href="../setup-cli/">
      Layer0 Setup CLI
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Layer0 Terraform Plugin" href="../terraform-plugin/">
      Layer0 Terraform Plugin
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Updating a Service" href="../updateservice/">
      Updating a Service
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Consul" href="../consul/">
      Consul
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Task Definitions" href="../task_definition/">
      Task Definitions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Architecture" href="../architecture/">
      Architecture
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="ECR" href="./">
      ECR
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Setup" href="#setup">
                Setup
              </a>
            </li>
          
            <li class="anchor">
              <a title="Deploy Example" href="#deploy-example">
                Deploy Example
              </a>
            </li>
          
            <li class="anchor">
              <a title="References" href="#references">
                References
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Troubleshooting</span>
    <ul>
      
        
  <li>
    <a class="" title="Common Issues" href="../../troubleshooting/commonissues/">
      Common Issues
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Secure Shell (SSH)" href="../../troubleshooting/ssh/">
      Secure Shell (SSH)
    </a>
    
  </li>

      
    </ul>
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="ec2-container-registry">EC2 Container Registry<a class="headerlink" href="#ec2-container-registry" title="Permanent link">#</a></h1>
<p>ECR is an Amazon implementation of a docker registry.  It acts as a private registry in your AWS account, which can be accessed from any docker client, and Layer0.  Consider using ECR if you have stability issues with hosted docker registries, and do not wish to share your images publicly on <a href="https://hub.docker.com/">dockerhub</a>.</p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">#</a></h2>
<p>When interacting with ECR, you will first need to create a repository and a login to interact from your development machine.</p>
<h3 id="repository">Repository<a class="headerlink" href="#repository" title="Permanent link">#</a></h3>
<p>Each repository needs to be created by an AWS api call.</p>
<pre class="code"><code>  &gt; aws ecr create-repository --repository-name myteam/myproject</code></pre>


<h3 id="login">Login<a class="headerlink" href="#login" title="Permanent link">#</a></h3>
<p>To authenticate with the ECR service, Amazon provides the <code>get-login</code> command, which generates an authentication token, and returns a docker command to set it up</p>
<pre class="code"><code>  &gt; aws ecr get-login
  # this command will return the following: (password is typically hundreds of characters)
  docker login -u AWS -p password -e none https://aws_account_id.dkr.ecr.us-east-1.amazonaws.com</code></pre>


<p>Execute the provided docker command to store the login credentials</p>
<p>Afterward creating the repository and local login credentials you may interact with images (and tags) under this path from a local docker client.</p>
<pre class="code"><code>  docker pull ${ecr-url}/myteam/myproject
  docker push ${ecr-url}/myteam/myproject:custom-tag-1</code></pre>


<h2 id="deploy-example">Deploy Example<a class="headerlink" href="#deploy-example" title="Permanent link">#</a></h2>
<p>Here we'll walk through using ECR when deploying to Layer0,  Using a very basic wait container.</p>
<h3 id="make-docker-image">Make docker image<a class="headerlink" href="#make-docker-image" title="Permanent link">#</a></h3>
<p>Your docker image can be built locally or pulled from dockerhub.  For this example, we made a service that waits and then exits (useful for triggering regular restarts).</p>
<pre class="code"><code>FROM busybox

ENV SLEEP_TIME=60

CMD sleep $SLEEP_TIME</code></pre>


<p>Then build the file, with the tag <code>xfra/wait</code></p>
<pre class="code"><code> &gt; docker build -f Dockerfile.wait -t xfra/wait .</code></pre>


<h3 id="upload-to-ecr">Upload to ECR<a class="headerlink" href="#upload-to-ecr" title="Permanent link">#</a></h3>
<p>After preparing a login and registry, tag the image with the remote url, and use <code>docker push</code></p>
<pre class="code"><code>  docker tag xfra/wait 111222333444.dkr.ecr.us-east-1.amazonaws.com/xfra-wait
  docker push 111222333444.dkr.ecr.us-east-1.amazonaws.com/xfra-wait</code></pre>


<div class="admonition note">
<p class="admonition-title">Note: your account id in this url will be different.</p>
</div>
<h3 id="create-a-deploy">Create a deploy<a class="headerlink" href="#create-a-deploy" title="Permanent link">#</a></h3>
<p>To run this image in Layer0, we create a dockerrun file, describing the instance and any additional variables</p>
<pre class="code"><code>{
  &quot;containerDefinitions&quot;: [
    {
      &quot;name&quot;: &quot;timeout&quot;,
      &quot;image&quot;: &quot;111222333444.dkr.ecr.us-east-1.amazonaws.com/xfra-wait:latest&quot;,
      &quot;essential&quot;: true,
      &quot;memory&quot;: 10,
      &quot;environment&quot;: [
        { &quot;name&quot;: &quot;SLEEP_TIME&quot;, &quot;value&quot;: &quot;43200&quot; }
      ]
    }
  ]
}</code></pre>


<p>And create that in Layer0</p>
<pre class="code"><code>  l0 deploy create timeout.dockerrun.aws.json timeout</code></pre>


<h3 id="deploy">Deploy<a class="headerlink" href="#deploy" title="Permanent link">#</a></h3>
<p>Finally, run that deploy as a service or a task. (the service will restart every 12 hours)</p>
<pre class="code"><code>  l0 service create demo timeoutsvc timeout:latest</code></pre>


<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">#</a></h2>
<ul>
<li><a href="http://docs.aws.amazon.com/AmazonECR/latest/userguide/ECR_AWSCLI.html">ECR User Guide</a></li>
<li><a href="http://docs.aws.amazon.com/cli/latest/reference/ecr/create-repository.html">create-repository</a></li>
<li><a href="http://docs.aws.amazon.com/cli/latest/reference/ecr/get-login.html">get-login</a></li>
</ul>
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../architecture/" title="Architecture">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Architecture
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../../troubleshooting/commonissues/" title="Common Issues">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Common Issues
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = 'quintilesims/layer0';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
    
  </body>
</html>