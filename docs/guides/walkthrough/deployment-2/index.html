<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Walkthrough: Deployment 2 - Layer0</title>
      
      
      
        <link rel="canonical" href="https://github.com/quintilesims/layer0/guides/walkthrough/deployment-2/">
      
      
        <meta name="author" content="xfra">
      
    
    <meta property="og:url" content="https://github.com/quintilesims/layer0/guides/walkthrough/deployment-2/">
    <meta property="og:title" content="Layer0">
    <meta property="og:image" content="https://github.com/quintilesims/layer0/guides/walkthrough/deployment-2//../../../static/logo_icon.png">
    <meta name="apple-mobile-web-app-title" content="Layer0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
      <link rel="apple-touch-icon" href="../../../static/logo_icon.png">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../../assets/fonts/icon.eot?52m981');
      	src: url('../../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../../assets/stylesheets/application-b64b728552.css">
    
      <link rel="stylesheet" href="../../../assets/stylesheets/palettes-05ab2406df.css">
    
    
      
      
      
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto+Mono">
      <style>
        body, input {
          font-family: 'Roboto', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script src="../../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class="palette-primary-red palette-accent-grey">
    
      
      
        
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Guides <i class="icon icon-link"></i>
              
            
          </span>
        
        Walkthrough: Deployment 2
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/quintilesims/layer0/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="../../../static/logo_icon.png">
        </div>
      
      <div class="name">
        <strong>Layer0 v0.10.0</strong>
        
          <br>
          quintilesims/layer0
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="../../../#download" title="Download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/quintilesims/layer0//stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Home" href="../../..">
      Home
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Releases" href="../../../releases/">
      Releases
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Introduction" href="../../../intro/">
      Introduction
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Setup</span>
    <ul>
      
        
  <li>
    <a class="" title="Install" href="../../../setup/install/">
      Install
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Upgrade" href="../../../setup/upgrade/">
      Upgrade
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Destroy" href="../../../setup/destroy/">
      Destroy
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Guides</span>
    <ul>
      
        
  <li>
    <a class="" title="Walkthrough: Introduction" href="../intro/">
      Walkthrough: Introduction
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Walkthrough: Deployment 1" href="../deployment-1/">
      Walkthrough: Deployment 1
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="Walkthrough: Deployment 2" href="./">
      Walkthrough: Deployment 2
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Deploy with Layer0 CLI" href="#deploy-with-layer0-cli">
                Deploy with Layer0 CLI
              </a>
            </li>
          
            <li class="anchor">
              <a title="Deploy with Terraform" href="#deploy-with-terraform">
                Deploy with Terraform
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
        
  <li>
    <a class="" title="Walkthrough: Deployment 3" href="../deployment-3/">
      Walkthrough: Deployment 3
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Terraform beyond Layer0" href="../../terraform_beyond_layer0/">
      Terraform beyond Layer0
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="One-off Task" href="../../one_off_task/">
      One-off Task
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Reference</span>
    <ul>
      
        
  <li>
    <a class="" title="Layer0 CLI" href="../../../reference/cli/">
      Layer0 CLI
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Layer0 Setup CLI" href="../../../reference/setup-cli/">
      Layer0 Setup CLI
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Layer0 Terraform Plugin" href="../../../reference/terraform-plugin/">
      Layer0 Terraform Plugin
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Updating a Service" href="../../../reference/updateservice/">
      Updating a Service
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Consul" href="../../../reference/consul/">
      Consul
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Task Definitions" href="../../../reference/task_definition/">
      Task Definitions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Architecture" href="../../../reference/architecture/">
      Architecture
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="ECR" href="../../../reference/ecr/">
      ECR
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Troubleshooting</span>
    <ul>
      
        
  <li>
    <a class="" title="Common Issues" href="../../../troubleshooting/commonissues/">
      Common Issues
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Secure Shell (SSH)" href="../../../troubleshooting/ssh/">
      Secure Shell (SSH)
    </a>
    
  </li>

      
    </ul>
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="deployment-2-guestbook-redis">Deployment 2: Guestbook + Redis<a class="headerlink" href="#deployment-2-guestbook-redis" title="Permanent link">#</a></h1>
<p>In this section, we're going to add some complexity to the previous deployment.
<a href="../deployment-1">Deployment 1</a> saw us create a simple guestbook application which kept its data in memory.
But what if that ever came down, either by intention or accident?
It would be easy enough to redeploy it, but all of the entered data would be lost.
What if we wanted to scale the application to run more than one copy?
For this deployment, we're going to separate the data store from the guestbook application by creating a second Layer0 service which will house a Redis database server and linking it to the first.
You can choose to complete this section using either <a href="#deploy-with-layer0-cli">the Layer0 CLI</a> or <a href="#deploy-with-terraform">Terraform</a>.</p>
<hr />
<h2 id="deploy-with-layer0-cli">Deploy with Layer0 CLI<a class="headerlink" href="#deploy-with-layer0-cli" title="Permanent link">#</a></h2>
<p>For this example, we'll be working in the <code>walkthrough/deployment-2/</code> directory of the <a href="https://github.com/quintilesims/guides/">guides</a> repo.
We assume that you've completed the <a href="../deployment-1#deploy-with-layer0-cli">Layer0 CLI</a> section of Deployment 1.</p>
<p>Files used in this deployment:</p>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Guestbook.Dockerrun.aws.json</code></td>
<td>Template for running the Guestbook application</td>
</tr>
<tr>
<td><code>Redis.Dockerrun.aws.json</code></td>
<td>Template for running a Redis server</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="part-1-create-the-redis-load-balancer">Part 1: Create the Redis Load Balancer<a class="headerlink" href="#part-1-create-the-redis-load-balancer" title="Permanent link">#</a></h3>
<p>Both the Guestbook service and the Redis service will live in the same Layer0 environment, so we don't need to create one like we did in the first deployment.
We'll start by making a load balancer behind which the Redis service will be deployed.</p>
<p>The <code>Redis.Dockerrun.aws.json</code> task definition file we'll use is very simple - it just spins up a Redis server with the default configuration, which means that it will be serving on port 6379.
Our load balancer needs to be able to forward TCP traffic to and from this port.
And since we don't want the Redis server to be exposed to the public internet, we'll put it behind a private load balancer; private load balancers only accept traffic that originates from within their own environment.
We'll also need to specify a non-default healthcheck target, since the load balancer won't expose port 80.
At the command prompt, execute the following:</p>
<p><code>l0 loadbalancer create --port 6379:6379/tcp --private --healthcheck-target tcp:6379 demo-env redis-lb</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>LOADBALANCER ID  LOADBALANCER NAME  ENVIRONMENT  SERVICE  PORTS          PUBLIC  URL
redislb16ae6     redis-lb           demo-env              6378:6379:TCP  false</code></pre>


<p>The following is a summary of the arguments passed in the above command:</p>
<ul>
<li><code>loadbalancer create</code>: creates a new load balancer</li>
<li><code>--port 6379:6379/TCP</code>: instructs the load balancer to forward requests from port 6379 on the load balancer to port 6379 in the EC2 instance using the TCP protocol</li>
<li><code>--private</code>: instructs the load balancer to ignore external traffic</li>
<li><code>--healthcheck-target tcp:6379</code>: instructs the load balancer to check the health of the service via TCP pings to port 6379</li>
<li><code>demo-env</code>: the name of the environment in which the load balancer is being created</li>
<li><code>redis-lb</code>: a name for the load balancer itself</li>
</ul>
<hr />
<h3 id="part-2-deploy-the-ecs-task-definition">Part 2: Deploy the ECS Task Definition<a class="headerlink" href="#part-2-deploy-the-ecs-task-definition" title="Permanent link">#</a></h3>
<p>Here, we just need to create the deploy using the <code>Redis.Dockerrun.aws.json</code> task definition file.
At the command prompt, execute the following:</p>
<p><code>l0 deploy create Redis.Dockerrun.aws.json redis-dpl</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>DEPLOY ID    DEPLOY NAME  VERSION
redis-dpl.1  redis-dpl    1</code></pre>


<p>The following is a summary of the arguments passed in the above command:</p>
<ul>
<li><code>deploy create</code>: creates a new Layer0 Deploy and allows you to specify an ECS task definition</li>
<li><code>Redis.Dockerrun.aws.json</code>: the file name of the ECS task definition (use the full path of the file if it is not in your current working directory)</li>
<li><code>redis-dpl</code>: a name for the deploy, which we will use later when we create the service</li>
</ul>
<hr />
<h3 id="part-3-create-the-redis-service">Part 3: Create the Redis Service<a class="headerlink" href="#part-3-create-the-redis-service" title="Permanent link">#</a></h3>
<p>Here, we just need to pull the previous resources together into a service.
At the command prompt, execute the following:</p>
<p><code>l0 service create --wait --loadbalancer demo-env:redis-lb demo-env redis-svc redis-dpl:latest</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>SERVICE ID    SERVICE NAME  ENVIRONMENT  LOADBALANCER  DEPLOYMENTS  SCALE
redislb16ae6  redis-svc     demo-env     redis-lb      redis-dpl:1  0/1</code></pre>


<p>The following is a summary of the arguments passed in the above commands:</p>
<ul>
<li><code>service create</code>: creates a new Layer0 Service</li>
<li><code>--wait</code>:  instructs the CLI to keep hold of the shell until the service has been successfully deployed</li>
<li><code>--loadbalancer demo-env:redis-lb</code>: the fully-qualified name of the load balancer; in this case, the load balancer named <strong>redis-lb</strong> in the environment named <strong>demo-env</strong><ul>
<li><em>(Again, it's not strictly necessary to use the fully-qualified name of the load balancer as long as there isn't another load balancer with the same name in a different environment)</em></li>
</ul>
</li>
<li><code>demo-env</code>: the name of the environment in which the service is to reside</li>
<li><code>redis-svc</code>: a name for the service we're creating</li>
<li><code>redis-dpl:latest</code>: the name of the deploy the service will put into action<ul>
<li><em>(We use <code>:</code> to specify which deploy we want - <code>:latest</code> will always give us the most recently-created one.)</em></li>
</ul>
</li>
</ul>
<hr />
<h3 id="part-4-check-the-status-of-the-redis-service">Part 4: Check the Status of the Redis Service<a class="headerlink" href="#part-4-check-the-status-of-the-redis-service" title="Permanent link">#</a></h3>
<p>As in the first deployment, we can keep an eye on our service by using the <code>service get</code> command:</p>
<p><code>l0 service get redis-svc</code></p>
<p>Once the service has finished scaling, try looking at the service's logs to see the output that the Redis server creates:</p>
<p><code>l0 service logs redis-svc</code></p>
<p>Among some warnings and information not important to this exercise and a fun bit of ASCII art, you should see something like the following:</p>
<pre class="code"><code>... # words and ASCII art
1:M 05 Apr 23:29:47.333 * The server is now ready to accept connections on port 6379</code></pre>


<p>Now we just need to teach the Guestbook application how to talk with our Redis service.</p>
<hr />
<h3 id="part-5-update-the-guestbook-deploy">Part 5: Update the Guestbook Deploy<a class="headerlink" href="#part-5-update-the-guestbook-deploy" title="Permanent link">#</a></h3>
<p>You should see in <code>walkthrough/deployment-2/</code> another <code>Guestbook.Dockerrun.aws.json</code> file.
This file is very similar to but not the same as the one in <code>deployment-1/</code> - if you open it up, you can see the following additions:</p>
<pre class="code"><code>    ...
    &quot;environment&quot;: [
        {
            &quot;name&quot;: &quot;GUESTBOOK_BACKEND_TYPE&quot;,
            &quot;value&quot;: &quot;redis&quot;
        },
        {
            &quot;name&quot;: &quot;GUESTBOOK_BACKEND_CONFIG&quot;,
            &quot;value&quot;: &quot;&lt;redis host and port here&gt;&quot;
        }
    ],
    ...</code></pre>


<p>The <code>"GUESTBOOK_BACKEND_CONFIG"</code> variable is what will point the Guestbook application towards the Redis server.
The <code>&lt;redis host and port here&gt;</code> section needs to be replaced and populated in the following format:</p>
<pre class="code"><code>&quot;value&quot;: &quot;ADDRESS_OF_REDIS_SERVER:PORT_THE_SERVER_IS_SERVING_ON&quot;</code></pre>


<p>We already know that Redis is serving on port 6379, so let's go find the server's address.
Remember, it lives behind a load balancer that we made, so run the following command:</p>
<p><code>l0 loadbalancer get redis-lb</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>LOADBALANCER ID  LOADBALANCER NAME  ENVIRONMENT  SERVICE    PORTS          PUBLIC  URL
redislb16ae6     redis-lb           demo-env     redis-svc  6379:6379/TCP  false   internal-l0-&lt;yadda-yadda&gt;.elb.amazonaws.com</code></pre>


<p>Copy that <code>URL</code> value, replace <code>&lt;redis host and port here&gt;</code> with the <code>URL</code> value in <code>Guestbook.Dockerrun.aws.json</code>, append <code>:6379</code> to it, and save the file.
It should look something like the following:</p>
<pre class="code"><code>    ...
    &quot;environment&quot;: [
        {
            &quot;name&quot;: &quot;GUESTBOOK_BACKEND_CONFIG&quot;,
            &quot;value&quot;: &quot;internal-l0-&lt;yadda-yadda&gt;.elb.amazonaws.com:6379&quot;
        }
    ],
    ...</code></pre>


<p>Now, we can create an updated deploy:</p>
<p><code>l0 deploy create Guestbook.Dockerrun.aws.json guestbook-dpl</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>DEPLOY ID        DEPLOY NAME    VERSION
guestbook-dpl.2  guestbook-dpl  2</code></pre>


<hr />
<h3 id="part-6-update-the-guestbook-service">Part 6: Update the Guestbook Service<a class="headerlink" href="#part-6-update-the-guestbook-service" title="Permanent link">#</a></h3>
<p>Almost all the pieces are in place!
Now we just need to apply the new Guestbook deploy to the running Guestbook service:</p>
<p><code>l0 service update guestbook-svc guestbook-dpl:latest</code></p>
<p>As the Guestbook service moves through the phases of its update process, we should see outputs like the following (if we keep an eye on the service with <code>l0 service get guestbook-svc</code>, that is):</p>
<pre class="code"><code>SERVICE ID    SERVICE NAME   ENVIRONMENT  LOADBALANCER  DEPLOYMENTS       SCALE
guestbo5fadd  guestbook-svc  demo-env     guestbook-lb  guestbook-dpl:2*  1/1
                                                        guestbook-dpl:1</code></pre>


<p><em>above: <code>guestbook-dpl:2</code> is in a transitional state</em></p>
<pre class="code"><code>SERVICE ID    SERVICE NAME   ENVIRONMENT  LOADBALANCER  DEPLOYMENTS      SCALE
guestbo5fadd  guestbook-svc  demo-env     guestbook-lb  guestbook-dpl:2  2/1
                                                        guestbook-dpl:1</code></pre>


<p><em>above: both versions of the deployment are running at scale</em></p>
<pre class="code"><code>SERVICE ID    SERVICE NAME   ENVIRONMENT  LOADBALANCER  DEPLOYMENTS       SCALE
guestbo5fadd  guestbook-svc  demo-env     guestbook-lb  guestbook-dpl:2   1/1
                                                        guestbook-dpl:1*</code></pre>


<p><em>above: <code>guestbook-dpl:1</code> is in a transitional state</em></p>
<pre class="code"><code>SERVICE ID    SERVICE NAME   ENVIRONMENT  LOADBALANCER  DEPLOYMENTS      SCALE
guestbo5fadd  guestbook-svc  demo-env     guestbook-lb  guestbook-dpl:2  1/1</code></pre>


<p><em>above: <code>guestbook-dpl:1</code> has been removed, and only <code>guestbook-dpl:2</code> remains</em></p>
<hr />
<h3 id="part-7-prove-it">Part 7: Prove It<a class="headerlink" href="#part-7-prove-it" title="Permanent link">#</a></h3>
<p>You should now be able to point your browser at the URL for the Guestbook load balancer (run <code>l0 loadbalancer get guestbook-lb</code> to find it) and see what looks like the same Guestbook application you deployed in the first section of the walkthrough.
Go ahead and add a few entries, make sure it's functioning properly.
We'll wait.</p>
<p>Now, let's prove that we've actually separated the data from the application by deleting and redeploying the Guestbook application:</p>
<p><code>l0 service delete --wait guestbook-svc</code></p>
<p><em>(We'll leave the <code>deploy</code> intact so we can spin up a new service easily, and we'll leave the environment untouched because it also contained the Redis server.
We'll also pass the <code>--wait</code> flag so that we don't need to keep checking on the status of the job to know when it's complete.)</em></p>
<p>Once those resources have been deleted, we can recreate them!</p>
<p>Create another service, using the <strong>guestbook-dpl</strong> deploy we kept around:</p>
<p><code>l0 service create --loadbalancer demo-env:guestbook-lb demo-env guestbook-svc guestbook-dpl:latest</code></p>
<p>Wait for everything to spin up, and hit that new load balancer's url (<code>l0 loadbalancer get guestbook-lb</code>) with your browser.
Your data should still be there!</p>
<hr />
<h3 id="cleanup">Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">#</a></h3>
<p>If you're finished with the example and don't want to continue with this walkthrough, you can instruct Layer0 to delete the environment and terminate the application.</p>
<p><code>l0 environment delete demo-env</code></p>
<p>However, if you intend to continue through <a href="../deployment-3">Deployment 3</a>, you will want to keep the resources you made in this section.</p>
<hr />
<h2 id="deploy-with-terraform">Deploy with Terraform<a class="headerlink" href="#deploy-with-terraform" title="Permanent link">#</a></h2>
<p>As before, we can complete this deployment using Terraform and the Layer0 provider instead of the Layer0 CLI. As before, we will assume that you've cloned the <a href="https://github.com/quintilesims/guides">guides</a> repo and are working in the <code>walkthrough/deployment-2/</code> directory.</p>
<p>We'll use these files to manage our deployment with Terraform:</p>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>main.tf</code></td>
<td>Provisions resources; populates variables in template files</td>
</tr>
<tr>
<td><code>outputs.tf</code></td>
<td>Values that Terraform will yield during deployment</td>
</tr>
<tr>
<td><code>terraform.tfstate</code></td>
<td>Tracks status of deployment <em>(created and managed by Terraform)</em></td>
</tr>
<tr>
<td><code>terraform.tfvars</code></td>
<td>Variables specific to the environment and application(s)</td>
</tr>
<tr>
<td><code>variables.tf</code></td>
<td>Values that Terraform will use during deployment</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="tf-a-brief-aside-revisited"><code>*.tf</code>: A Brief Aside: Revisited<a class="headerlink" href="#tf-a-brief-aside-revisited" title="Permanent link">#</a></h3>
<p>Not much is changed from <a href="../deployment-1#deploy-with-terraform">Deployment 1</a>.
In <code>main.tf</code>, we pull in a new, second module that will deploy Redis for us.
We maintain this module as well; you can inspect <a href="https://github.com/quintilesims/redis">the repo</a> if you'd like.</p>
<p>In <code>main.tf</code> where we pull in the Guestbook module, you'll see that we're supplying more values than we did last time, because we need some additional configuration to let the Guestbook application use a Redis backend instead of its default in-memory storage.</p>
<hr />
<h3 id="part-1-terraform-get">Part 1: Terraform Get<a class="headerlink" href="#part-1-terraform-get" title="Permanent link">#</a></h3>
<p>Run <code>terraform get</code> to pull down the source materials Terraform will use for deployment.
This will create a local <code>.terraform/</code> directory.</p>
<hr />
<h3 id="part-2-terraform-plan">Part 2: Terraform Plan<a class="headerlink" href="#part-2-terraform-plan" title="Permanent link">#</a></h3>
<p>It's always a good idea to find out what Terraform intends to do, so let's do that:</p>
<p><code>terraform plan</code></p>
<p>As before, we'll be prompted for any variables Terraform needs and doesn't have (see the note in <a href="../deployment-1#deploy-with-terraform">Deployment 1</a> for configuring Terraform variables).
We'll see output similar to the following:</p>
<pre class="code"><code>Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

data.template_file.redis: Refreshing state...
The Terraform execution plan has been generated and is shown below.
Resources are shown in alphabetical order for quick scanning. Green resources
will be created (or destroyed and then created if an existing resource
exists), yellow resources are being changed in-place, and red resources
will be destroyed. Cyan entries are data sources to be read.

Note: You didn't specify an &quot;-out&quot; parameter to save this plan, so when
&quot;apply&quot; is called, Terraform can't guarantee this is what will execute.

+ layer0_environment.demo
    ami:               &quot;&lt;computed&gt;&quot;
    cluster_count:     &quot;&lt;computed&gt;&quot;
    links:             &quot;&lt;computed&gt;&quot;
    name:              &quot;demo&quot;
    os:                &quot;linux&quot;
    security_group_id: &quot;&lt;computed&gt;&quot;
    size:              &quot;m3.medium&quot;

+ module.redis.layer0_deploy.redis
    content: &quot;{\n    \&quot;AWSEBDockerrunVersion\&quot;: 2,\n    \&quot;containerDefinitions\&quot;: [\n        {\n            \&quot;name\&quot;: \&quot;redis\&quot;,\n            \&quot;image\&quot;: \&quot;redis:3.2-alpine\&quot;,\n            \&quot;essential\&quot;: true,\n            \&quot;memory\&quot;: 128,\n            \&quot;portMappings\&quot;: [\n                {\n                    \&quot;hostPort\&quot;: 6379,\n              \&quot;containerPort\&quot;: 6379\n                }\n            ]\n        }\n    ]\n}\n\n&quot;
    name:    &quot;redis&quot;

+ module.redis.layer0_load_balancer.redis
    environment:                    &quot;${var.environment_id}&quot;
    health_check.#:                 &quot;&lt;computed&gt;&quot;
    name:                           &quot;redis&quot;
    port.#:                         &quot;1&quot;
    port.1072619732.certificate:    &quot;&quot;
    port.1072619732.container_port: &quot;6379&quot;
    port.1072619732.host_port:      &quot;6379&quot;
    port.1072619732.protocol:       &quot;tcp&quot;
    private:                        &quot;true&quot;
    url:                            &quot;&lt;computed&gt;&quot;

+ module.redis.layer0_service.redis
    deploy:        &quot;${ var.deploy_id == \&quot;\&quot; ? layer0_deploy.redis.id : var.deploy_id }&quot;
    environment:   &quot;${var.environment_id}&quot;
    load_balancer: &quot;${layer0_load_balancer.redis.id}&quot;
    name:          &quot;redis&quot;
    scale:         &quot;1&quot;
    wait:          &quot;true&quot;

&lt;= module.guestbook.data.template_file.guestbook
    rendered: &quot;&lt;computed&gt;&quot;
    template: &quot;{\n    \&quot;AWSEBDockerrunVersion\&quot;: 2,\n    \&quot;containerDefinitions\&quot;: [\n        {\n            \&quot;name\&quot;: \&quot;guestbook\&quot;,\n            \&quot;image\&quot;: \&quot;quintilesims/guestbook\&quot;,\n            \&quot;essential\&quot;: true,\n       \&quot;memory\&quot;: 128,\n            \&quot;environment\&quot;: [\n                {\n                    \&quot;name\&quot;: \&quot;GUESTBOOK_BACKEND_TYPE\&quot;,\n                    \&quot;value\&quot;: \&quot;${backend_type}\&quot;\n                },\n                {\n                    \&quot;name\&quot;: \&quot;GUESTBOOK_BACKEND_CONFIG\&quot;,\n                    \&quot;value\&quot;: \&quot;${backend_config}\&quot;\n                },\n                {\n                    \&quot;name\&quot;: \&quot;AWS_ACCESS_KEY_ID\&quot;,\n  \&quot;value\&quot;: \&quot;${access_key}\&quot;\n                },\n                {\n                    \&quot;name\&quot;: \&quot;AWS_SECRET_ACCESS_KEY\&quot;,\n                    \&quot;value\&quot;: \&quot;${secret_key}\&quot;\n                },\n                {\n            \&quot;name\&quot;: \&quot;AWS_REGION\&quot;,\n                    \&quot;value\&quot;: \&quot;${region}\&quot;\n                }\n   ],\n            \&quot;portMappings\&quot;: [\n                {\n                    \&quot;hostPort\&quot;: 80,\n     \&quot;containerPort\&quot;: 80\n                }\n            ]\n        }\n    ]\n}\n&quot;
    vars.%:   &quot;&lt;computed&gt;&quot;

+ module.guestbook.layer0_deploy.guestbook
    content: &quot;${data.template_file.guestbook.rendered}&quot;
    name:    &quot;guestbook&quot;

+ module.guestbook.layer0_load_balancer.guestbook
    environment:                    &quot;${var.environment_id}&quot;
    health_check.#:                 &quot;&lt;computed&gt;&quot;
    name:                           &quot;guestbook&quot;
    port.#:                         &quot;1&quot;
    port.2027667003.certificate:    &quot;&quot;
    port.2027667003.container_port: &quot;80&quot;
    port.2027667003.host_port:      &quot;80&quot;
    port.2027667003.protocol:       &quot;http&quot;
    url:                            &quot;&lt;computed&gt;&quot;

+ module.guestbook.layer0_service.guestbook
    deploy:        &quot;${ var.deploy_id == \&quot;\&quot; ? layer0_deploy.guestbook.id : var.deploy_id }&quot;
    environment:   &quot;${var.environment_id}&quot;
    load_balancer: &quot;${layer0_load_balancer.guestbook.id}&quot;
    name:          &quot;guestbook&quot;
    scale:         &quot;2&quot;
    wait:          &quot;true&quot;


Plan: 7 to add, 0 to change, 0 to destroy.</code></pre>


<p>We should see that Terraform intends to add 7 new resources, some of which are for the Guestbook deployment and some of which are for the Redis deployment.</p>
<hr />
<h3 id="part-2-terraform-apply">Part 2: Terraform Apply<a class="headerlink" href="#part-2-terraform-apply" title="Permanent link">#</a></h3>
<p>Run <code>terraform apply</code>, and we should see output similar to the following:</p>
<pre class="code"><code>data.template_file.redis: Refreshing state...
layer0_deploy.redis-dpl: Creating...

...
...
...

layer0_service.guestbook-svc: Creation complete

Apply complete! Resources: 7 added, 0 changed, 0 destroyed.

The state of your infrastructure has been saved to the path
below. This state is required to modify and destroy your
infrastructure, so keep it safe. To inspect the complete state
use the `terraform show` command.

State path: terraform.tfstate

Outputs:

guestbook_url = &lt;http endpoint for the sample application&gt;</code></pre>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It may take a few minutes for the guestbook service to launch and the load balancer to become available.
During that time you may get HTTP 503 errors when making HTTP requests against the load balancer URL.</p>
</div>
<h3 id="whats-happening">What's Happening<a class="headerlink" href="#whats-happening" title="Permanent link">#</a></h3>
<p>Terraform provisions the AWS resources through Layer0, configures environment variables for the application, and deploys the application into a Layer0 environment.
Terraform also writes the state of your deployment to the <code>terraform.tfstate</code> file (creating a new one if it's not already there).</p>
<h3 id="cleanup_1">Cleanup<a class="headerlink" href="#cleanup_1" title="Permanent link">#</a></h3>
<p>When you're finished with the example, you can instruct Terraform to destroy the Layer0 environment, and terminate the application.
Execute the following command (in the same directory):</p>
<p><code>terraform destroy</code></p>
<p>It's also now safe to remove the <code>.terraform/</code> directory and the <code>*.tfstate*</code> files.</p>
<hr />
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../deployment-1/" title="Walkthrough: Deployment 1">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Walkthrough: Deployment 1
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../deployment-3/" title="Walkthrough: Deployment 3">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Walkthrough: Deployment 3
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../../..';
      var repo_id  = 'quintilesims/layer0';
    </script>
    <script src="../../../assets/javascripts/application-997097ee0c.js"></script>
    
    
  </body>
</html>