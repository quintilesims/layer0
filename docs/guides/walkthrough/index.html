<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>An Iterative Walkthrough - Layer0</title>
      
      
      
        <link rel="canonical" href="https://github.com/quintilesims/layer0/guides/walkthrough/">
      
      
        <meta name="author" content="xfra">
      
    
    <meta property="og:url" content="https://github.com/quintilesims/layer0/guides/walkthrough/">
    <meta property="og:title" content="Layer0">
    <meta property="og:image" content="https://github.com/quintilesims/layer0/guides/walkthrough//../../static/logo_icon.png">
    <meta name="apple-mobile-web-app-title" content="Layer0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
      <link rel="apple-touch-icon" href="../../static/logo_icon.png">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-b64b728552.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/palettes-05ab2406df.css">
    
    
      
      
      
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto+Mono">
      <style>
        body, input {
          font-family: 'Roboto', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class="palette-primary-red palette-accent-grey">
    
      
      
        
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Guides <i class="icon icon-link"></i>
              
            
          </span>
        
        An Iterative Walkthrough
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/quintilesims/layer0/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="../../static/logo_icon.png">
        </div>
      
      <div class="name">
        <strong>Layer0 v0.9.0</strong>
        
          <br>
          quintilesims/layer0
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="../../#download" title="Download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/quintilesims/layer0//stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Home" href="../..">
      Home
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Releases" href="../../releases/">
      Releases
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Introduction" href="../../intro/">
      Introduction
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Setup</span>
    <ul>
      
        
  <li>
    <a class="" title="Install" href="../../setup/install/">
      Install
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Upgrade" href="../../setup/upgrade/">
      Upgrade
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Destroy" href="../../setup/destroy/">
      Destroy
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Guides</span>
    <ul>
      
        
  <li>
    <a class="current" title="An Iterative Walkthrough" href="./">
      An Iterative Walkthrough
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Deployment 1: A Simple Guestbook App" href="#deployment-1-a-simple-guestbook-app">
                Deployment 1: A Simple Guestbook App
              </a>
            </li>
          
            <li class="anchor">
              <a title="1a: Deploy with Layer0 CLI" href="#1a-deploy-with-layer0-cli">
                1a: Deploy with Layer0 CLI
              </a>
            </li>
          
            <li class="anchor">
              <a title="1b: Deploy with Terraform" href="#1b-deploy-with-terraform">
                1b: Deploy with Terraform
              </a>
            </li>
          
            <li class="anchor">
              <a title="Deployment 2: Guestbook + Redis" href="#deployment-2-guestbook-redis">
                Deployment 2: Guestbook + Redis
              </a>
            </li>
          
            <li class="anchor">
              <a title="2a: Deploy with Layer0 CLI" href="#2a-deploy-with-layer0-cli">
                2a: Deploy with Layer0 CLI
              </a>
            </li>
          
            <li class="anchor">
              <a title="2b: Deploy with Terraform" href="#2b-deploy-with-terraform">
                2b: Deploy with Terraform
              </a>
            </li>
          
            <li class="anchor">
              <a title="Deployment 3: Guestbook + Redis + Consul" href="#deployment-3-guestbook-redis-consul">
                Deployment 3: Guestbook + Redis + Consul
              </a>
            </li>
          
            <li class="anchor">
              <a title="3a: Deploy with Layer0 CLI" href="#3a-deploy-with-layer0-cli">
                3a: Deploy with Layer0 CLI
              </a>
            </li>
          
            <li class="anchor">
              <a title="3b: Deploy with Terraform" href="#3b-deploy-with-terraform">
                3b: Deploy with Terraform
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
        
  <li>
    <a class="" title="One-off Task" href="../one_off_task/">
      One-off Task
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Reference</span>
    <ul>
      
        
  <li>
    <a class="" title="Layer0 CLI" href="../../reference/cli/">
      Layer0 CLI
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Layer0 Setup CLI" href="../../reference/setup-cli/">
      Layer0 Setup CLI
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Layer0 Terraform Plugin" href="../../reference/terraform-plugin/">
      Layer0 Terraform Plugin
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Updating a Service" href="../../reference/updateservice/">
      Updating a Service
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Consul" href="../../reference/consul/">
      Consul
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Task Definitions" href="../../reference/task_definition/">
      Task Definitions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Architecture" href="../../reference/architecture/">
      Architecture
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="ECR" href="../../reference/ecr/">
      ECR
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Troubleshooting</span>
    <ul>
      
        
  <li>
    <a class="" title="Common Issues" href="../../troubleshooting/commonissues/">
      Common Issues
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Secure Shell (SSH)" href="../../troubleshooting/ssh/">
      Secure Shell (SSH)
    </a>
    
  </li>

      
    </ul>
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="an-iterative-walkthrough">An Iterative Walkthrough<a class="headerlink" href="#an-iterative-walkthrough" title="Permanent link">#</a></h1>
<p>This guide aims to take you through three increasingly-complex deployment examples using Layer0. Successive sections build upon the previous ones, and each deployment can be completed either through using the Layer0 CLI directly, or through Terraform using our custom <a href="../../reference/terraform-plugin">Layer0 Terraform Provider</a>.</p>
<p>We assume that you're using Layer0 v0.9.0 or later. If you have not already installed and configured Layer0, see the <a href="../../setup/install">installation guide</a>. If you are running an older version of Layer0, you may need to <a href="../../setup/upgrade#upgrading-older-versions-of-layer0">upgrade</a>.</p>
<p>If you intend to deploy services using the Layer0 Terraform Provider, you'll want to make sure that you've <a href="../../reference/terraform-plugin/#install">installed</a> the provider correctly.</p>
<p>Regardless of the deployment method you choose, you should also clone/download our <a href="https://github.com/quintilesims/layer0-examples/">examples repository</a>, which contains all the files you will need to progress through our guides. As you do so, we will assume that your working directory matches the part of the guide that you're following (for example, Deployment 1 of this guide will assume that your working directory is <code>.../layer0-examples/iterative-walkthrough/deployment-1/</code>).</p>
<p><strong>Table of Contents</strong>:</p>
<ul>
<li><a href="#deployment-1-a-simple-guestbook-app">Deployment 1</a>: Deploying a web service (Guestbook)</li>
<li><a href="#deployment-2-guestbook-redis">Deployment 2</a>: Deploying Guestbook and a data store service (Redis)</li>
<li><a href="#deployment-3-guestbook-redis-consul">Deployment 3</a>: Deploying Guestbook, Redis, and a service discovery service (Consul)</li>
</ul>
<h2 id="deployment-1-a-simple-guestbook-app">Deployment 1: A Simple Guestbook App<a class="headerlink" href="#deployment-1-a-simple-guestbook-app" title="Permanent link">#</a></h2>
<p>In this section you'll learn how different Layer0 commands work together to deploy applications to the cloud. The example application in this section is a guestbook -- a web application that acts as a simple message board. You can choose to complete this section using either the <a href="#1a-deploy-with-layer0-cli">Layer0 CLI</a> or <a href="#1b-deploy-with-terraform">Terraform</a>.</p>
<h2 id="1a-deploy-with-layer0-cli">1a: Deploy with Layer0 CLI<a class="headerlink" href="#1a-deploy-with-layer0-cli" title="Permanent link">#</a></h2>
<p>Remember, we assume that you're working in the <code>iterative-walkthrough/deployment-1/</code> directory, which contains the files you need for some of the commands in this section to work.</p>
<h3 id="part-1-create-the-environment">Part 1: Create the Environment<a class="headerlink" href="#part-1-create-the-environment" title="Permanent link">#</a></h3>
<p>The first step in deploying an application with Layer0 is to create an environment. An environment is a dedicated space in which one or more services can reside. Here, we'll create a new environment named <strong>demo-env</strong>. At the command prompt, execute the following:</p>
<p><code>l0 environment create demo-env</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>ENVIRONMENT ID  ENVIRONMENT NAME  CLUSTER COUNT  INSTANCE SIZE
demo00e6aa9     demo-env          0              m3.medium</code></pre>


<p>We can inspect our environments in a couple of different ways:</p>
<ul>
<li><code>l0 environment list</code> will give us a brief summary of all environments:</li>
</ul>
<pre class="code"><code>ENVIRONMENT ID  ENVIRONMENT NAME
demo00e6aa9     demo-env
api             api</code></pre>


<ul>
<li><code>l0 environment get demo-env</code> will show us more information about the <strong>demo-env</strong> environment we just created:</li>
</ul>
<pre class="code"><code>ENVIRONMENT ID  ENVIRONMENT NAME  CLUSTER COUNT  INSTANCE SIZE
demo00e6aa9     demo-env          0              m3.medium</code></pre>


<ul>
<li><code>l0 environment get \*</code> illustrates wildcard matching (you could also have used <code>demo*</code> in the above command), and will return detailed information for <em>each</em> environment, not just one - it's like a detailed <code>list</code>:</li>
</ul>
<pre class="code"><code>ENVIRONMENT ID  ENVIRONMENT NAME  CLUSTER COUNT  INSTANCE SIZE
demo00e6aa9     demo-env          0              m3.medium
api             api               2              m3.medium</code></pre>


<hr />
<h3 id="part-2-create-the-load-balancer">Part 2: Create the Load Balancer<a class="headerlink" href="#part-2-create-the-load-balancer" title="Permanent link">#</a></h3>
<p>In order to expose a web application to the public internet, we need to create a load balancer. A load balancer listens for web traffic at a specific address and directs that traffic to a Layer0 service.</p>
<p>A load balancer also has a notion of a health check - a way to assess whether or not the service is healthy and running properly. By default, Layer0 configures the health check of a load balancer based upon a simple TCP ping to port 80 every thirty seconds. Also by default, this ping will timeout after five seconds of no response from the service, and two consecutive successes or failures are required for the service to be considered healthy or unhealthy.</p>
<p>Here, we'll create a new load balancer named <strong>guestbook-lb</strong> inside of our environment named <strong>demo-env</strong>. The load balancer will listen on port 80, and forward that traffic along to port 80 in the Docker container using the HTTP protocol. Since the port configuration is already aligned with the default health check, we don't need to specify any health check configuration when we create this load balancer. At the command prompt, execute the following:</p>
<p><code>l0 loadbalancer create --port 80:80/http demo-env guestbook-lb</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>LOADBALANCER ID  LOADBALANCER NAME  ENVIRONMENT  SERVICE  PORTS       PUBLIC  URL
guestbodb65a     guestbook-lb       demo-env              80:80/HTTP  true</code></pre>


<p>The following is a summary of the arguments passed in the above command:</p>
<ul>
<li><code>loadbalancer create</code>: creates a new load balancer</li>
<li><code>--port 80:80/HTTP</code>: instructs the load balancer to forward requests from port 80 on the server to port 80 in the Docker container using the HTTP protocol</li>
<li><code>demo-env</code>: the name of the environment in which you are creating the load balancer</li>
<li><code>guestbook-lb</code>: a name for the load balancer itself</li>
</ul>
<p>You can inspect load balancers in the same way that you inspected environments in Part 1. Try running the following commands to get an idea of the information available to you:</p>
<ul>
<li><code>l0 loadbalancer list</code></li>
<li><code>l0 loadbalancer get guestbook-lb</code></li>
<li><code>l0 loadbalancer get gues*</code></li>
<li><code>l0 loadbalancer get \*</code></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice that the load balancer <code>list</code> and <code>get</code> outputs list an <code>ENVIRONMENT</code> field - if you ever have load balancers (or other Layer0 entities) with the same name but in different environments, you can target a specific load balancer by qualifying it with its environment name:</p>
<p><code>`l0 loadbalancer get demo-env:guestbook-lb`</code></p>
</div>
<hr />
<h3 id="part-3-deploy-the-docker-task-definition">Part 3: Deploy the Docker Task Definition<a class="headerlink" href="#part-3-deploy-the-docker-task-definition" title="Permanent link">#</a></h3>
<p>The <code>deploy</code> command is used to specify the Docker task definition that refers to a web application.</p>
<p>Here, we'll create a new deploy called <strong>guestbook-dpl</strong> that refers to the <strong>Guestbook.Dockerrun.aws.json</strong> file you obtained earlier. At the command prompt, execute the following:</p>
<p><code>l0 deploy create Guestbook.Dockerrun.aws.json guestbook-dpl</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>DEPLOY ID        DEPLOY NAME    VERSION
guestbook-dpl.1  guestbook-dpl  1</code></pre>


<p>The following is a summary of the arguments passed in the above command:</p>
<ul>
<li><code>deploy create</code>: creates a new deployment and allows you to specify a Docker task definition</li>
<li><code>Guestbook.Dockerrun.aws.json</code>: the file name of the Docker task definition (use the full path of the file if it is not in your current working directory)</li>
<li><code>guestbook-dpl</code>: a name for the deploy, which you will use later when you create the service</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>DEPLOY NAME</code> and <code>VERSION</code> are combined to create a unique identifier for a deploy. If you create additional deploys named <strong>guestbook-dpl</strong>, they will be assigned different version numbers.</p>
<p>You can always specify the latest version when targeting a deploy by using <code>&lt;deploy name&gt;:latest</code> -- for example, <code>guestbook-dpl:latest</code>.</p>
</div>
<p>Deploys support the same methods of inspection as environments and load balancers:</p>
<ul>
<li><code>l0 deploy list</code></li>
<li><code>l0 deploy get guestbook*</code></li>
<li><code>l0 deploy get \*</code></li>
</ul>
<hr />
<h3 id="part-4-create-the-service">Part 4: Create the Service<a class="headerlink" href="#part-4-create-the-service" title="Permanent link">#</a></h3>
<p>The final stage of the deployment process involves using the <code>service</code> command to create a new service and associate it with the environment, load balancer, and deploy that we created in the previous sections. The service will execute the Docker containers which have been described in the deploy.</p>
<p>Here, we'll create a new service called <strong>guestbook-svc</strong>. At the command prompt, execute the following:</p>
<p><code>l0 service create --loadbalancer demo-env:guestbook-lb demo-env guestbook-svc guestbook-dpl:latest</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>SERVICE ID    SERVICE NAME   ENVIRONMENT  LOADBALANCER  DEPLOYMENTS       SCALE
guestbo9364b  guestbook-svc  demo-env     guestbook-lb  guestbook-dpl:1*  0/1</code></pre>


<p>The following is a summary of the arguments passed in the above command:</p>
<ul>
<li><code>service create</code>: creates a new service</li>
<li><code>--loadbalancer demo-env:guestbook-lb</code>: the fully-qualified name of the load balancer; in this case, the load balancer named <strong>guestbook-lb</strong> in the environment named <strong>demo-env</strong>. <ul>
<li><em>(It is not strictly necessary to use the fully qualified name of the load balancer, unless another load balancer with exactly the same name exists in a different environment.)</em></li>
</ul>
</li>
<li><code>demo-env</code>: the name of the environment you created in Part 1</li>
<li><code>guestbook-svc</code>: a name for the service you are creating</li>
<li><code>guestbook-dpl</code>: the name of the deploy that you created in Part 3</li>
</ul>
<p>Layer0 services can be queried using the same <code>get</code> and <code>list</code> commands that we've come to expect by now.</p>
<hr />
<h3 id="check-the-status-of-the-service">Check the Status of the Service<a class="headerlink" href="#check-the-status-of-the-service" title="Permanent link">#</a></h3>
<p>After a service has been created, it may take several minutes for that service to completely finish deploying. A service's status may be checked by using the <code>service get</code> command.</p>
<p>Let's take a peek at our <strong>guestbook-svc</strong> service. At the command prompt, execute the following:</p>
<p><code>l0 service get demo-env:guestbook-svc</code></p>
<p>If we're quick enough, we'll be able to see the first stage of the process (this is what was output after running the <code>service create</code> command up in Part 4). We should see an asterisk (*) next to the name of the <strong>guestbook-dpl:1</strong> deploy, which indicates that the service is in a transitional state:</p>
<pre class="code"><code>SERVICE ID    SERVICE NAME   ENVIRONMENT  LOADBALANCER  DEPLOYMENTS       SCALE
guestbo9364b  guestbook-svc  demo-env     guestbook-lb  guestbook-dpl:1*  0/1</code></pre>


<p>In the next phase of deployment, if we execute the <code>service get</code> command again, we will see <strong>(1)</strong> in the <strong>Scale</strong> column; this indicates that 1 copy of the service is transitioning to an active state:</p>
<pre class="code"><code>SERVICE ID    SERVICE NAME   ENVIRONMENT  LOADBALANCER  DEPLOYMENTS       SCALE
guestbo9364b  guestbook-svc  demo-env     guestbook-lb  guestbook-dpl:1*  0/1 (1)</code></pre>


<p>We should see output like the following:</p>
<pre class="code"><code>SERVICE ID    SERVICE NAME   ENVIRONMENT  LOADBALANCER  DEPLOYMENTS       SCALE
guestbo9364b  guestbook-svc  demo-env     guestbook-lb  guestbook-dpl:1   1/1</code></pre>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>More detailed information about the state of a service may be acquired by running the following command:</p>
<p><code>l0 service logs &lt;SERVICE&gt;</code></p>
</div>
<hr />
<h3 id="get-the-applications-url">Get the Application's URL<a class="headerlink" href="#get-the-applications-url" title="Permanent link">#</a></h3>
<p>Once the service has been completely deployed, we can obtain the URL for the application and launch it in a browser.</p>
<p>At the command prompt, execute the following:</p>
<p><code>l0 loadbalancer get demo-env:guestbook-lb</code></p>
<p>We should see output like the following:</p>
<pre class="code"><code>LOADBALANCER ID  LOADBALANCER NAME  ENVIRONMENT  SERVICE        PORTS       PUBLIC  URL
guestbodb65a     guestbook-lb       demo-env     guestbook-svc  80:80/HTTP  true    &lt;url&gt;</code></pre>


<p>Copy the value shown in the <strong>URL</strong> column and paste it into a web browser. The guestbook application will appear (once the service has completely finished deploying).</p>
<hr />
<h3 id="cleanup">Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">#</a></h3>
<p>If you're finished with the example and don't want to continue with this walkthrough, you can instruct Layer0 to delete the environment and terminate the application.</p>
<p><code>l0 environment delete demo-env</code></p>
<p>However, if you intend to continue through <a href="#deployment-2-guestbook-redis">Deployment 2</a>, you will want to keep the resources you made in this section.</p>
<hr />
<h2 id="1b-deploy-with-terraform">1b: Deploy with Terraform<a class="headerlink" href="#1b-deploy-with-terraform" title="Permanent link">#</a></h2>
<p>Instead of using the Layer0 CLI directly, you can instead use our Terraform provider, and deploy using Terraform <em>(<a href="../../reference/terraform-plugin">learn more</a>)</em>. You can use Terraform with Layer0 and AWS to create "fire-and-forget" deployments for your applications.</p>
<p>Remember, we assume that you've cloned the <a href="https://github.com/quintilesims/layer0-examples">layer0-examples</a> repo and are working in the <code>iterative-walkthrough/deployment-1/</code> directory.</p>
<p>We use these files to set up a Layer0 envrionment with Terraform:</p>
<table>
<thead>
<tr>
<th>Filename</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>terraform.tfvars</code></td>
<td>Variables specific to the environment and guestbook application</td>
</tr>
<tr>
<td><code>Guestbook.Dockerrun.aws.json</code></td>
<td>Template for running the guestbook application in a Layer0 environment</td>
</tr>
<tr>
<td><code>layer0.tf</code></td>
<td>Provision Layer0 resources and populate variables in <code>Guestbook.Dockerrun.aws.json</code></td>
</tr>
</tbody>
</table>
<h3 id="part-1-terraform-plan">Part 1: Terraform Plan<a class="headerlink" href="#part-1-terraform-plan" title="Permanent link">#</a></h3>
<p>Before we actually create/update/delete any resources, it's a good idea to find out what Terraform intends to do.</p>
<p>Run <code>terraform plan</code>. Terraform will prompt you for configuration values that it does not have:</p>
<pre class="code"><code>var.endpoint
    Enter a value:

var.token
    Enter a value:</code></pre>


<p>You can find these values by running <code>l0-setup endpoint &lt;your layer0 prefix&gt;</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are a few ways to configure Terraform so that you don't have to keep entering these values everytime you run a Terraform command (editing the <code>terraform.tfvars</code> file, or exporting evironment variables like <code>TF_VAR_endpoint</code> and <code>TF_VAR_token</code>, for example). See the <a href="https://www.terraform.io/docs/configuration/variables.html">Terraform Docs</a> for more.</p>
</div>
<p>The <code>plan</code> command should give us output like the following:</p>
<pre class="code"><code>+ layer0_deploy.guestbook
    content: &quot;{\n    \&quot;AWSEBDockerrunVersion\&quot;: 2,\n    \&quot;containerDefinitions\&quot;: [\n        {\n            \&quot;name\&quot;: \&quot;guestbook\&quot;,\n            \&quot;image\&quot;: \&quot;quintilesims/guestbook\&quot;,\n            \&quot;essential\&quot;: true,\n            \&quot;memory\&quot;: 128,\n            \&quot;portMappings\&quot;: [\n                {\n                    \&quot;hostPort\&quot;: 80,\n                    \&quot;containerPort\&quot;: 80\n                }\n            ]\n        }\n    ]\n}\n&quot;
    name:    &quot;guestbook&quot;

+ layer0_environment.demo
    cluster_count:     &quot;&lt;computed&gt;&quot;
    name:              &quot;demo&quot;
    security_group_id: &quot;&lt;computed&gt;&quot;
    size:              &quot;m3.medium&quot;

+ layer0_load_balancer.guestbook
    environment:                    &quot;${layer0_environment.demo.id}&quot;
    health_check.#:                 &quot;&lt;computed&gt;&quot;
    name:                           &quot;guestbook&quot;
    port.#:                         &quot;1&quot;
    port.2027667003.certificate:    &quot;&quot;
    port.2027667003.container_port: &quot;80&quot;
    port.2027667003.host_port:      &quot;80&quot;
    port.2027667003.protocol:       &quot;http&quot;
    url:                            &quot;&lt;computed&gt;&quot;

+ layer0_service.guestbook
    deploy:        &quot;${layer0_deploy.guestbook.id}&quot;
    environment:   &quot;${layer0_environment.demo.id}&quot;
    load_balancer: &quot;${layer0_load_balancer.guestbook.id}&quot;
    name:          &quot;guestbook&quot;
    scale:         &quot;1&quot;


Plan: 4 to add, 0 to change, 0 to destroy.</code></pre>


<p>This shows you that Terraform intends to create a deploy, an environment, a load balancer, and a service, all through Layer0.</p>
<p>If you've gone through <a href="#1a-deploy-with-layer0-cli">Deployment 1a</a> which used the Layer0 CLI, you may notice that these resources appear out of order - that's fine. Terraform presents these resources in alphabetical order, but underneath, it knows the correct order in which to create them.</p>
<p>Once we're satisfied that Terraform will do what we want it to do, we can move on to actually making these things exist!</p>
<hr />
<h3 id="part-2-terraform-apply">Part 2: Terraform Apply<a class="headerlink" href="#part-2-terraform-apply" title="Permanent link">#</a></h3>
<p>Run <code>terraform apply</code> to begin the process.</p>
<p>We should see output like the following:</p>
<pre class="code"><code>layer0_environment.demo: Refreshing state...
...
...
...
layer0_service.guestbook: Creation complete

Apply complete! Resources: 7 added, 0 changed, 0 destroyed.

The state of your infrastructure has been saved to the path
below. This state is required to modify and destroy your
infrastructure, so keep it safe. To inspect the complete state
use the `terraform show` command.

State path: terraform.tfstate

Outputs:

guestbook_url = &lt;http endpoint for the sample application&gt;</code></pre>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It may take a few minutes for the guestbook service to launch and the load balancer to become available. During that time you may get HTTP 503 errors when making HTTP requests against the load balancer URL.</p>
</div>
<h3 id="whats-happening">What's happening<a class="headerlink" href="#whats-happening" title="Permanent link">#</a></h3>
<p>Terraform provisions the AWS resources through Layer0, configures environment variables for the application, and deploys the application into a Layer0 environment. Terraform also writes the state of your deployment to the <code>terraform.tfstate</code> file (creating a new one if it's not already there).</p>
<h3 id="cleanup_1">Cleanup<a class="headerlink" href="#cleanup_1" title="Permanent link">#</a></h3>
<p>When you're finished with the example, you can instruct Terraform to destroy the Layer0 environment, and terminate the application. Execute the following command (in the same directory):</p>
<p><code>terraform destroy</code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As previously stated, Terraform writes the latest status of your deployment to <code>terraform.tfstate</code>. As you move on to <a href="#2b-deploy-with-terraform">Deployment 2</a> of this walkthrough, it will be easier for you to just destroy your Terraform deployment with <code>terraform destroy</code>.</p>
<p>However, the <code>apply</code> command is idempotent -- if you'd like, you may bring your <code>terraform.tfstate</code> file with you when you change directories to <code>iterative-walkthrough/deployment-2/</code>. When you run <code>terraform apply</code> in the next section of this walkthrough, Terraform will create new resources as expected - but it will also update existing resources that have changes and destroy resources that are no longer necessary, and update <code>terraform.tfstate</code> accordingly.</p>
</div>
<hr />
<h2 id="deployment-2-guestbook-redis">Deployment 2: Guestbook + Redis<a class="headerlink" href="#deployment-2-guestbook-redis" title="Permanent link">#</a></h2>
<p>INTRO TEXT GOES HERE. You can choose to complete this section using either the <a href="#2a-deploy-with-layer0-cli">Layer0 CLI</a> or <a href="#2b-deploy-with-terraform">Terraform</a>.</p>
<h2 id="2a-deploy-with-layer0-cli">2a: Deploy with Layer0 CLI<a class="headerlink" href="#2a-deploy-with-layer0-cli" title="Permanent link">#</a></h2>
<hr />
<h3 id="part-1">Part 1:<a class="headerlink" href="#part-1" title="Permanent link">#</a></h3>
<hr />
<h2 id="2b-deploy-with-terraform">2b: Deploy with Terraform<a class="headerlink" href="#2b-deploy-with-terraform" title="Permanent link">#</a></h2>
<hr />
<h3 id="part-1_1">Part 1:<a class="headerlink" href="#part-1_1" title="Permanent link">#</a></h3>
<hr />
<h2 id="deployment-3-guestbook-redis-consul">Deployment 3: Guestbook + Redis + Consul<a class="headerlink" href="#deployment-3-guestbook-redis-consul" title="Permanent link">#</a></h2>
<p>INTRO TEXT GOES HERE. You can choose to complete this section using either the <a href="#3a-deploy-with-layer0-cli">Layer0 CLI</a> or <a href="#3b-deploy-with-terraform">Terraform</a>.</p>
<h2 id="3a-deploy-with-layer0-cli">3a: Deploy with Layer0 CLI<a class="headerlink" href="#3a-deploy-with-layer0-cli" title="Permanent link">#</a></h2>
<hr />
<h3 id="part-1_2">Part 1:<a class="headerlink" href="#part-1_2" title="Permanent link">#</a></h3>
<hr />
<h2 id="3b-deploy-with-terraform">3b: Deploy with Terraform<a class="headerlink" href="#3b-deploy-with-terraform" title="Permanent link">#</a></h2>
<hr />
<h3 id="part-1_3">Part 1:<a class="headerlink" href="#part-1_3" title="Permanent link">#</a></h3>
<hr />
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../../setup/destroy/" title="Destroy">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Destroy
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../one_off_task/" title="One-off Task">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                One-off Task
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = 'quintilesims/layer0';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
    
  </body>
</html>